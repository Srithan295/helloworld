pipeline {
  agent {
    docker { image 'python:3.11-slim' }
  }
  options { timestamps() }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Install') {
      steps {
        sh 'python -m pip install --upgrade pip'
        sh 'pip install -r requirements.txt || true'   // ok if file absent
        sh 'pip install pytest pytest-cov build'
      }
    }
    stage('Lint & Test') {
      steps {
        sh '''
          mkdir -p reports
          pytest -q --junitxml=reports/junit.xml \
                 --cov=. --cov-report=xml:reports/coverage.xml
        '''
      }
      post {
        always {
          junit 'reports/junit.xml'
          archiveArtifacts artifacts: 'reports/**', fingerprint: true
          // If you have Code Coverage API plugin:
          // recordCoverage(tools: [coberturaAdapter('reports/coverage.xml')])
        }
      }
    }
    stage('Package (optional)') {
      steps {
        sh 'python -m build'   // creates dist/*.whl / *.tar.gz
      }
      post {
        success { archiveArtifacts artifacts: 'dist/*', fingerprint: true }
      }
    }
  }
}
